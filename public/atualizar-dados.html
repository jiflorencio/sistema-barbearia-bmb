<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMB Barbearia - Atualizar Dados</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .box {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }
        
        .box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 4s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .box h2 {
            margin-bottom: 20px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4em;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }

        /* Status Cards */
        .status-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .status-card.warning {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
        }
        
        .status-card.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-item .label {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .status-item .value {
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Alerts */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .alert.warning {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            animation: pulse 2s infinite;
        }
        
        .alert.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        
        .alert.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        /* Forms - DO SISTEMA ORIGINAL */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #FFD700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"], input[type="tel"], input[type="date"], input[type="file"] {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus, input[type="tel"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.1);
            transform: translateY(-1px);
        }

        input[type="text"]::placeholder, input[type="tel"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input[type="file"] {
            padding: 16px;
            border-style: dashed;
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }

        /* Charts */
        .mini-chart {
            height: 100px;
            display: flex;
            align-items: end;
            gap: 5px;
            padding: 10px 0;
            margin: 10px 0;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #ffd700, #ffed4e);
            border-radius: 2px 2px 0 0;
            position: relative;
            transition: all 0.3s ease;
            min-height: 10px;
        }
        
        .chart-bar:hover {
            filter: brightness(1.2);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #ffd700;
        }

        /* SISTEMA DE ALERTAS DO ORIGINAL */
        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            white-space: pre-line;
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            white-space: pre-line;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            white-space: pre-line;
        }

        .file-info {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            color: #FFD700;
            font-size: 14px;
            font-weight: 500;
        }

        /* BARRA DE PROGRESSO DO ORIGINAL */
        .progress-container {
            display: none;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
            backdrop-filter: blur(10px);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 32px;
            margin: 32px 0;
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.3);
        }

        .progress-container.active {
            display: block;
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .progress-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
        }

        .progress-bar-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 25px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            background-size: 200% 100%;
            border-radius: 25px;
            width: 0%;
            transition: width 0.3s ease;
            animation: progressGradient 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @keyframes progressGradient {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .progress-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            text-align: center;
        }

        .progress-stat {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .progress-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #FFD700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .progress-stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-percentage {
            font-size: 2.5rem !important;
            color: #FFD700 !important;
        }

        .progress-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ESTILOS DO BMB ORIGINAL */
        .btn-back {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000000;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #FFA500, #FFD700);
        }

        .bmb-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            border: 2px solid #FFD700;
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.3);
            display: block;
            flex-shrink: 0;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .header-info h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .progress-info {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header com visual novo + bot√£o do sistema original -->
        <div class="header fade-in">
            <div class="header-info">
                <img src="https://barbeariabmb.com.br/wp-content/uploads/2023/11/logomarca-colorido-fundo-preto-1.webp" alt="BMB Barbearia" class="bmb-logo">
                <div>
                    <h1>Atualizar Banco de Dados</h1>
                    <p>BMB Jd S√£o Paulo</p>
                </div>
                <a href="/dashboard" class="btn-back">
                    ‚Üê Voltar ao Dashboard
                </a>
            </div>
        </div>

        <!-- Container de alertas do sistema original -->
        <div id="alerts"></div>

        <!-- BARRA DE PROGRESSO DO SISTEMA ORIGINAL -->
        <div id="progressContainer" class="progress-container">
            <div class="progress-header">
                <div class="progress-title">
                    <span class="progress-spinner"></span>
                    <span id="progressTitle">Processando arquivo...</span>
                </div>
                <div class="progress-subtitle" id="progressSubtitle">Aguarde enquanto processamos os dados</div>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="progress-info">
                <div class="progress-stat">
                    <div class="progress-stat-value progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-stat-label">Progresso</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="progressCurrent">0</div>
                    <div class="progress-stat-label">Processados</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="progressTotal">0</div>
                    <div class="progress-stat-label">Total</div>
                </div>
            </div>
        </div>

        <!-- Main Grid com os 3 boxes -->
        <div class="main-grid">
            
            <!-- 1. IMPORTAR CADASTRO -->
            <div class="box fade-in">
                <h2>üìÅ Importar Cadastro</h2>
                
                <div class="alert info">
                    <span>üí°</span>
                    <span>Use esta op√ß√£o para importar v√°rios clientes de uma vez atrav√©s de uma planilha Excel.</span>
                </div>

                <div class="form-group">
                    <label for="excelFile">Selecione o arquivo Excel (.xlsx ou .xls):</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls">
                    <div class="file-info">
                        <strong>üìã Formato da planilha:</strong><br>
                        ‚Ä¢ <strong>Coluna A:</strong> Nome (ex: Jo√£o Silva)<br>
                        ‚Ä¢ <strong>Coluna B:</strong> DDI (ex: 55)<br>
                        ‚Ä¢ <strong>Coluna C:</strong> Telefone (ex: (11) 99999-9999 ou 11999999999)<br>
                        ‚Ä¢ <strong>Coluna D:</strong> Data de Nascimento (ex: 15/05/1990)<br><br>
                        <strong>üìû Telefone:</strong> Pode vir formatado (11) 99999-9999 ou apenas n√∫meros 11999999999. Ser√° automaticamente formatado no padr√£o (xx) xxxxx-xxxx<br>
                        <strong>‚ö†Ô∏è Importante:</strong> A primeira linha deve conter os cabe√ßalhos: Nome, DDI, Telefone, Data de Nascimento
                    </div>
                </div>
                
                <button class="btn" onclick="uploadExcel()">
                    üì§ Importar Cadastro
                </button>

                <div style="margin-top: 15px;">
                    <h5>üìà Evolu√ß√£o de Cadastros</h5>
                    <div class="mini-chart">
                        <div class="chart-bar" style="height: 40%;"></div>
                        <div class="chart-bar" style="height: 60%;"></div>
                        <div class="chart-bar" style="height: 80%;"></div>
                        <div class="chart-bar" style="height: 90%;"></div>
                        <div class="chart-bar" style="height: 100%;"></div>
                        <div class="chart-bar" style="height: 75%;"></div>
                    </div>
                </div>
            </div>

            <!-- 2. IMPORTAR/ATUALIZAR MOVIMENTO -->
            <div class="box fade-in">
                <h2>üèÜ Importar/Atualizar Movimento de Clientes</h2>
                
                <!-- Status do Movimento com funcionalidades extras -->
                <div class="status-card info">
                    <h4>üìä Status dos Movimentos</h4>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="label">üìÖ √öltima Importa√ß√£o</div>
                            <div class="value" id="lastMovimentoDate">Nunca</div>
                        </div>
                        <div class="status-item">
                            <div class="label">üìä Movimentos</div>
                            <div class="value" id="totalMovimentosCount">0</div>
                        </div>
                        <div class="status-item">
                            <div class="label">‚è±Ô∏è H√° quanto tempo</div>
                            <div class="value" id="movimentoTimeSince">-</div>
                        </div>
                    </div>
                    
                    <div class="alert success" id="movimentoAlert">
                        <span>üí°</span>
                        <span>Importe o primeiro arquivo de movimentos para come√ßar o controle!</span>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o Extras -->
                <div style="margin: 15px 0;">
                    <button class="btn secondary" onclick="openMovimentoHistory()">üìã Ver Hist√≥rico</button>
                    <button class="btn secondary" onclick="analyzeLastImport()">üîç Analisar √öltima</button>
                    <button class="btn secondary" onclick="exportMovimentos()">üíæ Backup</button>
                </div>

                <!-- Upload de Movimento - SISTEMA ORIGINAL -->
                <div class="alert-info">
                    <strong>üíº Hist√≥rico de Atendimentos:</strong> Use esta op√ß√£o para importar o hist√≥rico de servi√ßos dos clientes.
                    <br><strong>üìù O que faz:</strong>
                    <br>‚Ä¢ Se o telefone existe na base ‚Üí adiciona servi√ßos ao cliente
                    <br>‚Ä¢ Se o telefone n√£o existe ‚Üí cria novo cliente com os servi√ßos
                </div>
                
                <div class="form-group">
                    <label for="servicosFile">Selecione o arquivo Excel de servi√ßos (.xlsx ou .xls):</label>
                    <input type="file" id="servicosFile" accept=".xlsx,.xls">
                    <div class="file-info">
                        <strong>üìã Formato da planilha de servi√ßos:</strong><br>
                        ‚Ä¢ <strong>Coluna A:</strong> Servi√ßo (ex: Corte, Barba, Escova)<br>
                        ‚Ä¢ <strong>Coluna B:</strong> Cliente (ex: Jo√£o Silva)<br>
                        ‚Ä¢ <strong>Coluna C:</strong> Telefone (ex: (11) 99999-9999 ou 11999999999)<br>
                        ‚Ä¢ <strong>Coluna D:</strong> Profissional (ex: Carlos, Pedro)<br>
                        ‚Ä¢ <strong>Coluna E:</strong> Data (ex: 15/01/2025)<br><br>
                        <strong>üìû Telefone:</strong> Pode vir formatado (11) 99999-9999 ou apenas n√∫meros 11999999999. Ser√° automaticamente formatado no padr√£o (xx) xxxxx-xxxx<br>
                        <strong>‚ö†Ô∏è Importante:</strong> A primeira linha deve conter os cabe√ßalhos: Servi√ßo, Cliente, Telefone, Profissional, Data
                    </div>
                </div>
                
                <button class="btn" onclick="uploadServicos()">
                    üèÜ Importar Servi√ßos
                </button>

                <div style="margin-top: 15px;">
                    <h5>üìà Movimento Semanal</h5>
                    <div class="mini-chart">
                        <div class="chart-bar" style="height: 70%;"></div>
                        <div class="chart-bar" style="height: 85%;"></div>
                        <div class="chart-bar" style="height: 95%;"></div>
                        <div class="chart-bar" style="height: 100%;"></div>
                        <div class="chart-bar" style="height: 80%;"></div>
                        <div class="chart-bar" style="height: 60%;"></div>
                        <div class="chart-bar" style="height: 90%;"></div>
                    </div>
                </div>
            </div>

            <!-- 3. ADICIONAR CLIENTE MANUALMENTE -->
            <div class="box fade-in">
                <h2>üë§ Adicionar Cliente Manualmente</h2>
                
                <div class="alert info">
                    <span>‚úçÔ∏è</span>
                    <span>Preencha os dados abaixo para adicionar um cliente por vez.</span>
                </div>

                <!-- Formul√°rio de Cadastro - SISTEMA ORIGINAL -->
                <form id="clienteForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome Completo:</label>
                            <input type="text" id="nome" required placeholder="Ex: Jo√£o Silva">
                        </div>
                        
                        <div class="form-group">
                            <label for="ddi">DDI (C√≥digo do Pa√≠s):</label>
                            <input type="text" id="ddi" required placeholder="Ex: 55" value="55">
                        </div>
                        
                        <div class="form-group">
                            <label for="telefone">Telefone:</label>
                            <input type="tel" id="telefone" required placeholder="Ex: (11) 99999-9999">
                        </div>
                        
                        <div class="form-group">
                            <label for="dataNascimento">Data de Nascimento:</label>
                            <input type="date" id="dataNascimento" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">
                        üíæ Salvar Cliente
                    </button>
                    <button type="button" class="btn secondary" onclick="limparFormulario()">
                        üóëÔ∏è Limpar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Universal -->
    <div id="universalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- Conte√∫do ser√° inserido dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        let clienteEditando = null;
        let progressInterval = null;

        // Dados simulados para status (atualizados pelos uploads reais)
        let movementStats = {
            lastImport: null,
            totalMovements: 0,
            thisMonth: 0
        };

        // FUN√á√ïES DE FORMATA√á√ÉO DE TELEFONE DO SISTEMA ORIGINAL
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            
            // Remove tudo que n√£o √© n√∫mero
            const apenasNumeros = telefone.toString().replace(/\D/g, '');
            
            // Se tem 11 d√≠gitos (celular com DDD)
            if (apenasNumeros.length === 11) {
                return `(${apenasNumeros.slice(0, 2)}) ${apenasNumeros.slice(2, 7)}-${apenasNumeros.slice(7)}`;
            }
            // Se tem 10 d√≠gitos (fixo com DDD)  
            else if (apenasNumeros.length === 10) {
                return `(${apenasNumeros.slice(0, 2)}) ${apenasNumeros.slice(2, 6)}-${apenasNumeros.slice(6)}`;
            }
            // Se tem 9 d√≠gitos (celular sem DDD)
            else if (apenasNumeros.length === 9) {
                return `${apenasNumeros.slice(0, 5)}-${apenasNumeros.slice(5)}`;
            }
            // Se tem 8 d√≠gitos (fixo sem DDD)
            else if (apenasNumeros.length === 8) {
                return `${apenasNumeros.slice(0, 4)}-${apenasNumeros.slice(4)}`;
            }
            // Para outros tamanhos, retorna apenas os n√∫meros
            else {
                return apenasNumeros;
            }
        }

        function aplicarMascaraTelefone(input) {
            const valorFormatado = formatarTelefone(input.value);
            input.value = valorFormatado;
        }

        // FUN√á√ïES DA BARRA DE PROGRESSO DO SISTEMA ORIGINAL
        function mostrarProgresso(titulo, subtitulo = 'Aguarde enquanto processamos os dados') {
            const container = document.getElementById('progressContainer');
            const titleElement = document.getElementById('progressTitle');
            const subtitleElement = document.getElementById('progressSubtitle');
            
            titleElement.textContent = titulo;
            subtitleElement.textContent = subtitulo;
            
            // Reset dos valores
            atualizarProgresso(0, 0, 0);
            
            container.classList.add('active');
            
            // Scroll suave para a barra de progresso
            container.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        function ocultarProgresso() {
            const container = document.getElementById('progressContainer');
            container.classList.remove('active');
            
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function atualizarProgresso(atual, total, percentual = null) {
            if (percentual === null && total > 0) {
                percentual = Math.round((atual / total) * 100);
            }
            
            document.getElementById('progressCurrent').textContent = atual;
            document.getElementById('progressTotal').textContent = total;
            document.getElementById('progressPercentage').textContent = `${percentual || 0}%`;
            document.getElementById('progressBar').style.width = `${percentual || 0}%`;
        }

        function simularProgressoImportacao(totalLinhas, tipoImportacao = 'clientes') {
            let currentProgress = 0;
            const incremento = Math.max(1, Math.ceil(totalLinhas / 50)); // Incrementa de forma suave
            
            progressInterval = setInterval(() => {
                currentProgress += incremento;
                
                if (currentProgress >= totalLinhas) {
                    currentProgress = totalLinhas;
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                atualizarProgresso(currentProgress, totalLinhas);
                
                // Atualizar subt√≠tulo com base no progresso e tipo
                const subtitle = document.getElementById('progressSubtitle');
                const progPercent = currentProgress / totalLinhas;
                
                if (tipoImportacao === 'servicos') {
                    if (progPercent < 0.3) {
                        subtitle.textContent = `Validando dados dos servi√ßos...`;
                    } else if (progPercent < 0.6) {
                        subtitle.textContent = `Buscando clientes existentes...`;
                    } else if (progPercent < 0.9) {
                        subtitle.textContent = `Adicionando servi√ßos ao hist√≥rico...`;
                    } else {
                        subtitle.textContent = `Finalizando importa√ß√£o de servi√ßos...`;
                    }
                } else {
                    if (progPercent < 0.3) {
                        subtitle.textContent = `Lendo e validando dados...`;
                    } else if (progPercent < 0.7) {
                        subtitle.textContent = `Verificando duplicatas...`;
                    } else if (progPercent < 1.0) {
                        subtitle.textContent = `Salvando no banco de dados...`;
                    } else {
                        subtitle.textContent = `Processamento conclu√≠do!`;
                    }
                }
                
            }, 100); // Atualiza a cada 100ms
        }

        // FUN√á√ïES DE STATUS DOS MOVIMENTOS
        function updateMovementStatus() {
            // Atualizar status na interface
            document.getElementById('lastMovimentoDate').textContent = 
                movementStats.lastImport ? movementStats.lastImport.toLocaleDateString('pt-BR') : 'Nunca';
            document.getElementById('totalMovimentosCount').textContent = movementStats.totalMovements.toLocaleString();
            
            // Calcular tempo decorrido
            if (movementStats.lastImport) {
                const now = new Date();
                const diff = now - movementStats.lastImport;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                let timeText = '';
                if (days > 0) {
                    timeText = `${days} dia${days > 1 ? 's' : ''} atr√°s`;
                } else if (hours > 0) {
                    timeText = `${hours} hora${hours > 1 ? 's' : ''} atr√°s`;
                } else {
                    timeText = 'H√° poucos minutos';
                }
                
                document.getElementById('movimentoTimeSince').textContent = timeText;
                updateSmartAlert(days);
            } else {
                document.getElementById('movimentoTimeSince').textContent = '-';
                updateSmartAlert(999); // Nunca importou
            }
        }

        function updateSmartAlert(daysSince) {
            const alertContainer = document.getElementById('movimentoAlert');
            
            if (daysSince >= 999) {
                alertContainer.className = 'alert info';
                alertContainer.innerHTML = '<span>üí°</span><span>Importe o primeiro arquivo de movimentos para come√ßar o controle!</span>';
            } else if (daysSince >= 7) {
                alertContainer.className = 'alert warning';
                alertContainer.innerHTML = `<span>‚ö†Ô∏è</span><span>Faz mais de ${daysSince} dias sem importa√ß√£o! Recomendamos atualizar os dados.</span>`;
            } else if (daysSince >= 3) {
                alertContainer.className = 'alert info';
                alertContainer.innerHTML = '<span>üí°</span><span>Considere verificar se h√° novos dados para importar.</span>';
            } else {
                alertContainer.className = 'alert success';
                alertContainer.innerHTML = '<span>‚úÖ</span><span>Dados atualizados recentemente. Sistema em dia!</span>';
            }
        }

        // FUN√á√ïES DE MODAL E A√á√ïES EXTRAS
        function openMovimentoHistory() {
            const content = `
                <h2 style="color: #ffd700; margin-bottom: 20px;">üìã Hist√≥rico de Importa√ß√µes - Movimentos</h2>
                <div style="margin: 20px 0;">
                    <input type="text" placeholder="üîç Buscar por data ou arquivo..." style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ffd700; background: rgba(0,0,0,0.3); color: #fff;">
                </div>
                <div id="historyList">
                    <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ffd700;">
                        <div style="font-weight: bold; color: #ffd700;">üìÖ Nenhuma importa√ß√£o ainda</div>
                        <div style="margin-top: 5px; opacity: 0.8;">Importe o primeiro arquivo de movimentos para ver o hist√≥rico aqui.</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn secondary">üìä Exportar Relat√≥rio</button>
                    <button class="btn secondary">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
            `;
            openModal(content);
        }

        function analyzeLastImport() {
            if (!movementStats.lastImport) {
                showNotification('üìù Nenhuma importa√ß√£o foi realizada ainda.', 'info');
                return;
            }
            
            showNotification('üîç Analisando √∫ltima importa√ß√£o...', 'info');
            setTimeout(() => {
                showNotification(`üìä √öltima importa√ß√£o: ${movementStats.lastImport.toLocaleDateString('pt-BR')} | Total: ${movementStats.totalMovements} movimentos`, 'success');
            }, 1500);
        }

        function exportMovimentos() {
            showNotification('üíæ Exportando backup dos movimentos...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Backup exportado: movimentos_backup_' + new Date().toISOString().split('T')[0] + '.xlsx', 'success');
            }, 2000);
        }

        function openModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('universalModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('universalModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // FUN√á√ÉO DE NOTIFICA√á√ÉO
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1001';
            notification.style.minWidth = '300px';
            notification.style.maxWidth = '400px';
            notification.innerHTML = `<span>${message}</span>`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacao();
            
            // Inicializar status dos movimentos
            updateMovementStatus();
            
            // Event listener para formul√°rio
            document.getElementById('clienteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                adicionarCliente();
            });
            
            // Event listener para formata√ß√£o autom√°tica do telefone
            const telefoneInput = document.getElementById('telefone');
            if (telefoneInput) {
                // Formatar enquanto digita
                telefoneInput.addEventListener('input', function() {
                    aplicarMascaraTelefone(this);
                });
                
                // Formatar quando sai do campo
                telefoneInput.addEventListener('blur', function() {
                    aplicarMascaraTelefone(this);
                });
            }
        });

        // TODAS AS FUN√á√ïES DO SISTEMA ORIGINAL
        
        // Verificar autentica√ß√£o
        async function verificarAutenticacao() {
            try {
                const response = await fetch('/api/auth-status');
                const data = await response.json();
                
                if (!data.logado) {
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                window.location.href = '/';
            }
        }

        // Fun√ß√£o para mostrar alertas do sistema original
        function mostrarAlert(mensagem, tipo = 'success') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = mensagem;
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Adicionar novo cliente
        async function adicionarCliente() {
            const nome = document.getElementById('nome').value.trim();
            let ddi = document.getElementById('ddi').value.trim();
            let telefone = document.getElementById('telefone').value.trim();
            const dataNascimento = document.getElementById('dataNascimento').value;
            
            // Limpar DDI removendo + se houver
            ddi = ddi.replace(/^\+/, ''); // Remove + do in√≠cio se existir
            if (!ddi || ddi === '') {
                ddi = '55'; // Padr√£o Brasil se vazio
            }
            
            // Garantir que o telefone est√° formatado antes de enviar
            telefone = formatarTelefone(telefone);
            
            if (!nome || !ddi || !telefone || !dataNascimento) {
                mostrarAlert('Por favor, preencha todos os campos.', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/clientes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome, ddi, telefone, dataNascimento })
                });
                
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                if (response.ok) {
                    mostrarAlert(`‚úÖ Cliente "${nome}" adicionado com sucesso!`, 'success');
                    limparFormulario();
                } else {
                    const erro = await response.json();
                    mostrarAlert(erro.erro || 'Erro ao adicionar cliente', 'error');
                }
            } catch (error) {
                mostrarAlert('Erro de conex√£o', 'error');
                console.error('Erro:', error);
            }
        }

        // Upload de Excel
        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarAlert('Por favor, selecione um arquivo Excel.', 'error');
                return;
            }
            
            // Verificar se √© arquivo Excel
            const tipoArquivo = file.name.toLowerCase();
            if (!tipoArquivo.endsWith('.xlsx') && !tipoArquivo.endsWith('.xls')) {
                mostrarAlert('Por favor, selecione apenas arquivos Excel (.xlsx ou .xls)', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('excel', file);
            
            try {
                // Mostrar barra de progresso
                mostrarProgresso('üì§ Importando Cadastro de Clientes', 'Enviando arquivo para o servidor...');
                
                // Simular progresso inicial (leitura do arquivo)
                setTimeout(() => {
                    atualizarProgresso(1, 100, 5);
                    document.getElementById('progressSubtitle').textContent = 'Lendo arquivo Excel...';
                }, 200);
                
                const response = await fetch('/api/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 401) {
                    ocultarProgresso();
                    window.location.href = '/';
                    return;
                }
                
                const resultado = await response.json();
                
                if (response.ok) {
                    // Simular progresso do processamento baseado no total de linhas
                    if (resultado.totalLinhas > 0) {
                        atualizarProgresso(5, 100, 10);
                        document.getElementById('progressSubtitle').textContent = `Processando ${resultado.totalLinhas} registros...`;
                        
                        // Simular o processamento linha por linha
                        simularProgressoImportacao(resultado.totalLinhas, 'clientes');
                        
                        // Aguardar conclus√£o da simula√ß√£o
                        await new Promise(resolve => {
                            const checkComplete = setInterval(() => {
                                if (!progressInterval) {
                                    clearInterval(checkComplete);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    // Finalizar progresso
                    atualizarProgresso(resultado.totalLinhas || 100, resultado.totalLinhas || 100, 100);
                    document.getElementById('progressSubtitle').textContent = '‚úÖ Importa√ß√£o conclu√≠da com sucesso!';
                    
                    // Aguardar um pouco antes de ocultar
                    setTimeout(() => {
                        ocultarProgresso();
                    }, 2000);
                    
                    // Mostrar resultado detalhado
                    let mensagemCompleta = `üéâ ${resultado.mensagem}`;
                    
                    if (resultado.sucessos && resultado.sucessos.length > 0) {
                        console.log('‚úÖ Clientes adicionados com sucesso:', resultado.sucessos);
                    }
                    
                    if (resultado.erros && resultado.erros.length > 0) {
                        console.log('‚ö†Ô∏è Detalhes dos erros/avisos:', resultado.erros);
                        
                        if (resultado.clientesJaExistem > 0) {
                            mensagemCompleta += `\n\nüìã ${resultado.clientesJaExistem} clientes j√° existiam na base (n√£o foram duplicados).`;
                        }
                        
                        if (resultado.totalErros > 0) {
                            mensagemCompleta += `\n\n‚ö†Ô∏è ${resultado.totalErros} erros encontrados. Verifique o console (F12) para detalhes.`;
                        }
                        
                        // Mostrar alguns erros na tela para facilitar
                        if (resultado.erros.length > 0) {
                            const primeirosErros = resultado.erros.slice(0, 5);
                            mensagemCompleta += `\n\nüîç Principais problemas encontrados:\n${primeirosErros.join('\n')}`;
                            
                            if (resultado.erros.length > 5) {
                                mensagemCompleta += `\n... e mais ${resultado.erros.length - 5} erros (veja console F12)`;
                            }
                        }
                    }
                    
                    mostrarAlert(mensagemCompleta, 'success');
                    fileInput.value = '';
                    
                    // Mostrar estat√≠sticas detalhadas
                    if (resultado.totalLinhas > 0) {
                        setTimeout(() => {
                            const estatisticas = `üìä RESUMO DETALHADO DA IMPORTA√á√ÉO:
‚Ä¢ Total de linhas processadas: ${resultado.totalLinhas}
‚Ä¢ Clientes novos adicionados: ${resultado.clientesInseridos}
‚Ä¢ Clientes que j√° existiam: ${resultado.clientesJaExistem || 0}
‚Ä¢ Linhas com erro: ${resultado.totalErros || 0}

${resultado.primeiraLinhaExemplo ? 'üîß Colunas detectadas: ' + resultado.primeiraLinhaExemplo.join(', ') : ''}

‚úÖ IMPORTA√á√ÉO CONCLU√çDA COM SUCESSO!`;
                            
                            mostrarAlert(estatisticas, 'info');
                        }, 1000);
                    }
                } else {
                    ocultarProgresso();
                    mostrarAlert(resultado.erro || 'Erro ao processar arquivo Excel', 'error');
                    if (resultado.detalhes) {
                        console.error('Detalhes do erro:', resultado.detalhes);
                    }
                }
            } catch (error) {
                ocultarProgresso();
                mostrarAlert('Erro ao fazer upload do arquivo', 'error');
                console.error('Erro:', error);
            }
        }

        // Upload de hist√≥rico de servi√ßos
        async function uploadServicos() {
            const fileInput = document.getElementById('servicosFile');
            const file = fileInput.files[0];
            if (!file) {
                mostrarAlert('Por favor, selecione um arquivo de servi√ßos.', 'error');
                return;
            }
            const tipoArquivo = file.name.toLowerCase();
            if (!tipoArquivo.endsWith('.xlsx') && !tipoArquivo.endsWith('.xls')) {
                mostrarAlert('Por favor, selecione apenas arquivos Excel (.xlsx ou .xls)', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('excel', file);
            
            try {
                // Mostrar barra de progresso para servi√ßos
                mostrarProgresso('üèÜ Importando Hist√≥rico de Servi√ßos', 'Enviando arquivo para o servidor...');
                
                // Simular progresso inicial
                setTimeout(() => {
                    atualizarProgresso(1, 100, 5);
                    document.getElementById('progressSubtitle').textContent = 'Lendo arquivo de servi√ßos...';
                }, 200);
                
                const response = await fetch('/api/upload-servicos', {
                    method: 'POST',
                    body: formData
                });
                if (response.status === 401) {
                    ocultarProgresso();
                    window.location.href = '/';
                    return;
                }
                const resultado = await response.json();
                if (response.ok) {
                    // Simular progresso do processamento
                    if (resultado.totalLinhas > 0) {
                        atualizarProgresso(5, 100, 10);
                        document.getElementById('progressSubtitle').textContent = `Processando ${resultado.totalLinhas} registros de servi√ßos...`;
                        
                        // Simular o processamento espec√≠fico para servi√ßos
                        simularProgressoImportacao(resultado.totalLinhas, 'servicos');
                        
                        // Aguardar conclus√£o da simula√ß√£o
                        await new Promise(resolve => {
                            const checkComplete = setInterval(() => {
                                if (!progressInterval) {
                                    clearInterval(checkComplete);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    // Finalizar progresso
                    atualizarProgresso(resultado.totalLinhas || 100, resultado.totalLinhas || 100, 100);
                    document.getElementById('progressSubtitle').textContent = '‚úÖ Importa√ß√£o de servi√ßos conclu√≠da!';
                    
                    // ATUALIZAR STATUS DOS MOVIMENTOS
                    movementStats.lastImport = new Date();
                    movementStats.totalMovements += resultado.servicosAdicionados || 0;
                    movementStats.thisMonth += resultado.servicosAdicionados || 0;
                    updateMovementStatus();
                    
                    // Aguardar um pouco antes de ocultar
                    setTimeout(() => {
                        ocultarProgresso();
                    }, 2000);
                    
                    let mensagemCompleta = `üéâ ${resultado.mensagem || 'Hist√≥rico importado com sucesso!'}`;
                    if (resultado.sucessos && resultado.sucessos.length > 0) {
                        console.log('‚úÖ Servi√ßos adicionados com sucesso:', resultado.sucessos);
                    }
                    if (resultado.erros && resultado.erros.length > 0) {
                        console.log('‚ö†Ô∏è Detalhes dos erros/avisos:', resultado.erros);
                        if (resultado.totalErros > 0) {
                            mensagemCompleta += `\n\n‚ö†Ô∏è ${resultado.totalErros} erros encontrados. Verifique o console (F12) para detalhes.`;
                        }
                        if (resultado.erros.length > 0) {
                            const primeirosErros = resultado.erros.slice(0, 5);
                            mensagemCompleta += `\n\nüîç Principais problemas encontrados:\n${primeirosErros.join('\n')}`;
                            if (resultado.erros.length > 5) {
                                mensagemCompleta += `\n... e mais ${resultado.erros.length - 5} erros (veja console F12)`;
                            }
                        }
                    }
                    mostrarAlert(mensagemCompleta, 'success');
                    fileInput.value = '';
                    if (resultado.totalLinhas > 0) {
                        setTimeout(() => {
                            const estatisticas = `üìä RESUMO DA IMPORTA√á√ÉO DE SERVI√áOS:
‚Ä¢ Total de linhas: ${resultado.totalLinhas}
‚Ä¢ Servi√ßos adicionados: ${resultado.servicosAdicionados || 0}
‚Ä¢ Clientes atualizados: ${resultado.clientesAtualizados || 0}
‚Ä¢ Clientes novos criados: ${resultado.clientesNovos || 0}
‚Ä¢ Linhas com erro: ${resultado.totalErros || 0}

‚úÖ IMPORTA√á√ÉO DE SERVI√áOS CONCLU√çDA!`;
                            mostrarAlert(estatisticas, 'info');
                        }, 1000);
                    }
                } else {
                    ocultarProgresso();
                    mostrarAlert(resultado.erro || 'Erro ao processar arquivo de servi√ßos', 'error');
                    if (resultado.detalhes) {
                        console.error('Detalhes do erro:', resultado.detalhes);
                    }
                }
            } catch (error) {
                ocultarProgresso();
                mostrarAlert('Erro ao fazer upload do arquivo de servi√ßos', 'error');
                console.error('Erro:', error);
            }
        }

        // Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('clienteForm').reset();
            document.getElementById('ddi').value = '55'; // Recolocar valor padr√£o
        }

        // Fechar modal clicando fora
        window.onclick = function(event) {
            const modal = document.getElementById('universalModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>